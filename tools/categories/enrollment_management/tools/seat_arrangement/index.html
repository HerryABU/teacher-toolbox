<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多功能智能座位编排系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.11/dist/interact.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #5a5c69;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container-main {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #eaecf4;
        }
        
        .nav-tabs .nav-link {
            color: #6e707e;
            border: none;
            padding: 12px 20px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            border-color: transparent;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 600;
            background-color: transparent;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .student-card {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: move;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            opacity: 0.95;
            user-select: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            opacity: 1;
        }
        
        .student-card.girl {
            border-left-color: #e83e8c;
            background-color: rgba(232, 62, 140, 0.1);
        }
        
        .student-card.boy {
            border-left-color: #4e73df;
            background-color: rgba(78, 115, 223, 0.1);
        }
        
        .seat {
            width: 100%;
            height: 100%;
            border: 1px solid #dddfeb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fc;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .seat:hover {
            background-color: #e2e6ea;
        }
        
        .seat.occupied {
            background-color: rgba(78, 115, 223, 0.15);
        }
        
        .seat.empty {
            background-color: #f8f9fc;
        }
        
        .seat.reserved {
            background-color: rgba(231, 74, 59, 0.15);
        }
        
        .classroom-grid {
            display: grid;
            gap: 12px;
            margin: 25px 0;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
            border-radius: 0.35rem;
        }
        
        .badge-mbti {
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .badge-vision {
            font-size: 0.75rem;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 22px;
            height: 22px;
            border-radius: 6px;
        }
        
        .mbti-legend {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .mbti-type {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 0.85rem;
            cursor: help;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: transform 0.2s;
        }
        
        .mbti-type:hover {
            transform: translateY(-2px);
        }
        
        .rules-container {
            background-color: #f8f9fc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dddfeb;
        }
        
        .rule-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-left: 4px solid var(--primary-color);
        }
        
        .preview-container {
            border: 1px dashed #dddfeb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            background-color: #f8f9fc;
        }
        
        .tab-content {
            padding: 25px 0;
        }
        
        .form-section {
            background-color: #f8f9fc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dddfeb;
        }
        
        .height-indicator {
            height: 5px;
            background-color: #d1d3e2;
            margin-top: 8px;
            position: relative;
            border-radius: 3px;
        }
        
        .height-indicator::after {
            content: '';
            position: absolute;
            top: -4px;
            width: 12px;
            height: 12px;
            background-color: var(--primary-color);
            border-radius: 50%;
            left: var(--pos);
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
        }
        
        .teacher-desk {
            background-color: #f6e1c3;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            grid-column: span var(--cols);
            margin-bottom: 20px;
            border: 1px solid #dddfeb;
        }
        
        .blackboard {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            grid-column: span var(--cols);
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
        }
        
        .seat-container {
            position: relative;
        }
        
        .seat-actions {
            position: absolute;
            top: -12px;
            right: -12px;
            display: none;
            z-index: 10;
        }
        
        .seat-container:hover .seat-actions {
            display: block;
        }
        
        .dragging {
            opacity: 0.7;
            background: rgba(78, 115, 223, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(78, 115, 223, 0.3);
        }
        
        .dropzone {
            background-color: rgba(78, 115, 223, 0.1);
            border: 2px dashed var(--primary-color);
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
            .no-print, .no-print * {
                display: none !important;
            }
            .student-card, .seat {
                cursor: default;
            }
            .student-card {
                margin-bottom: 5px;
            }
            .classroom-grid {
                gap: 5px;
            }
            .seat {
                height: 50px;
                font-size: 0.8rem;
            }
        }
        
        .classroom-layout-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }
        
        .layout-preview-item {
            width: 140px;
            height: 100px;
            border: 1px solid #dddfeb;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s;
            background-color: white;
        }
        
        .layout-preview-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        
        .layout-preview-item.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.3);
        }
        
        .layout-preview-row {
            display: flex;
            flex: 1;
        }
        
        .layout-preview-seat {
            flex: 1;
            border: 1px solid #eee;
        }
        
        .layout-preview-seat.single {
            background-color: #f8f9fc;
        }
        
        .layout-preview-seat.pair {
            background-color: #e2e6ea;
        }
        
        .layout-preview-seat.reserved {
            background-color: rgba(231, 74, 59, 0.15);
        }
        
        .layout-preview-seat.teacher {
            background-color: #f6e1c3;
        }
        
        .mixed-left {
            grid-column: span 1;
        }
        
        .mixed-center {
            grid-column: span 2;
        }
        
        .mixed-right {
            grid-column: span 1;
        }
        
        .grid-column-span-2 {
            grid-column: span 2;
        }
        
        .modal-content {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            border-bottom: 1px solid #eaecf4;
            padding: 1.5rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-top: 1px solid #eaecf4;
            padding: 1.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.35rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2653d4;
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #17a673;
            border-color: #169b6b;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #d62c1a;
            border-color: #c52717;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: #1f2d3d;
        }
        
        .btn-warning:hover {
            background-color: #e0b12e;
            border-color: #d9aa2b;
            color: #1f2d3d;
        }
        
        .btn-info {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }
        
        .btn-info:hover {
            background-color: #2c9faf;
            border-color: #2a96a5;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background-color: #717384;
            border-color: #6b6d7d;
        }
        
        .form-control, .form-select {
            border-radius: 0.35rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d3e2;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }
        
        .input-group-text {
            background-color: #eaecf4;
            border: 1px solid #d1d3e2;
        }
        
        .alert {
            border-radius: 0.35rem;
            padding: 1rem;
        }
        
        .swal2-popup {
            border-radius: 10px !important;
        }
        
        .swal2-title {
            font-size: 1.5rem !important;
        }
        
        .swal2-content {
            font-size: 1rem !important;
        }
        
        .swal2-confirm {
            background-color: var(--primary-color) !important;
        }
        
        .swal2-cancel {
            background-color: var(--secondary-color) !important;
        }
        
        .swal2-icon {
            width: 4em !important;
            height: 4em !important;
        }
        
        .swal2-icon-content {
            font-size: 2.75em !important;
        }
        
        .tooltip-inner {
            border-radius: 0.35rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .badge-mbti-I {
            background-color: #6f42c1;
            color: white;
        }
        
        .badge-mbti-E {
            background-color: #20c997;
            color: white;
        }
        
        .bg-primary {
            background-color: var(--primary-color) !important;
        }
        
        .bg-success {
            background-color: var(--success-color) !important;
        }
        
        .bg-info {
            background-color: var(--info-color) !important;
        }
        
        .bg-warning {
            background-color: var(--warning-color) !important;
        }
        
        .bg-danger {
            background-color: var(--danger-color) !important;
        }
        
        .bg-secondary {
            background-color: var(--secondary-color) !important;
        }
        
        .bg-dark {
            background-color: var(--dark-color) !important;
        }
        
        .bg-light {
            background-color: var(--light-color) !important;
        }
        
        .text-primary {
            color: var(--primary-color) !important;
        }
        
        .text-success {
            color: var(--success-color) !important;
        }
        
        .text-info {
            color: var(--info-color) !important;
        }
        
        .text-warning {
            color: var(--warning-color) !important;
        }
        
        .text-danger {
            color: var(--danger-color) !important;
        }
        
        .text-secondary {
            color: var(--secondary-color) !important;
        }
        
        .text-dark {
            color: var(--dark-color) !important;
        }
        
        .text-light {
            color: var(--light-color) !important;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #eaecf4;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .table {
            color: #333;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(78, 115, 223, 0.05);
        }
        
        .custom-file-input:focus ~ .custom-file-label {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }
        
        .custom-file-label {
            border-radius: 0.35rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d3e2;
        }
        
        .custom-control-input:checked ~ .custom-control-label::before {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .custom-switch .custom-control-label::before {
            border-radius: 0.35rem;
        }
        
        .custom-switch .custom-control-input:checked ~ .custom-control-label::after {
            background-color: white;
            transform: translateX(0.75rem);
        }
        
        .progress {
            height: 0.5rem;
            border-radius: 0.25rem;
        }
        
        .progress-bar {
            background-color: var(--primary-color);
        }
        
        .dropdown-menu {
            border: none;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            border-radius: 0.35rem;
        }
        
        .dropdown-item {
            padding: 0.5rem 1.5rem;
        }
        
        .dropdown-item:hover {
            background-color: rgba(78, 115, 223, 0.1);
            color: var(--primary-color);
        }
        
        .dropdown-item.active {
            background-color: var(--primary-color);
        }
        
        .breadcrumb {
            background-color: transparent;
            padding: 0;
        }
        
        .breadcrumb-item.active {
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .pagination .page-link {
            color: var(--primary-color);
            border: 1px solid #d1d3e2;
        }
        
        .pagination .page-link:hover {
            color: #2e59d9;
            background-color: #eaecf4;
            border-color: #d1d3e2;
        }
        
        .list-group-item {
            border: 1px solid #eaecf4;
        }
        
        .list-group-item.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .list-group-item-action:hover {
            background-color: #f8f9fc;
        }
        
        .toast {
            border: none;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            border-radius: 0.35rem;
        }
        
        .toast-header {
            border-bottom: 1px solid #eaecf4;
        }
        
        .custom-range::-webkit-slider-thumb {
            background: var(--primary-color);
        }
        
        .custom-range::-moz-range-thumb {
            background: var(--primary-color);
        }
        
        .custom-range::-ms-thumb {
            background: var(--primary-color);
        }
        
        .spinner-border {
            color: var(--primary-color);
        }
        
        .spinner-grow {
            color: var(--primary-color);
        }
        
        .border-primary {
            border-color: var(--primary-color) !important;
        }
        
        .border-success {
            border-color: var(--success-color) !important;
        }
        
        .border-info {
            border-color: var(--info-color) !important;
        }
        
        .border-warning {
            border-color: var(--warning-color) !important;
        }
        
        .border-danger {
            border-color: var(--danger-color) !important;
        }
        
        .border-secondary {
            border-color: var(--secondary-color) !important;
        }
        
        .border-dark {
            border-color: var(--dark-color) !important;
        }
        
        .border-light {
            border-color: var(--light-color) !important;
        }
        
        .shadow {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
        }
        
        .shadow-sm {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
        }
        
        .shadow-lg {
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175) !important;
        }
        
        .shadow-none {
            box-shadow: none !important;
        }
        
        .swapping {
            animation: swapPulse 0.5s infinite alternate;
        }
        
        @keyframes swapPulse {
            from {
                box-shadow: 0 0 0 0 rgba(78, 115, 223, 0.4);
            }
            to {
                box-shadow: 0 0 0 10px rgba(78, 115, 223, 0);
            }
        }
    </style>
</head>
<body>
    <div id="app" class="container container-main">
        <h1 class="text-center mb-4"><i class="fas fa-chair me-2"></i>多功能智能座位编排系统</h1>
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#" @click="currentTab = 'students'">学生管理</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" @click="currentTab = 'arrange'">座位编排</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" @click="currentTab = 'rules'">编排规则</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" @click="currentTab = 'import'">数据导入</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" @click="currentTab = 'export'">数据导出</a>
            </li>
        </ul>
        <div class="tab-content">
            <!-- 学生管理标签页 -->
            <div v-if="currentTab === 'students'" class="no-print">
                <div class="d-flex justify-content-between mb-4">
                    <h3><i class="fas fa-users me-2"></i>学生列表</h3>
                    <button class="btn btn-primary" @click="showAddStudentModal = true">
                        <i class="fas fa-plus me-1"></i>添加学生
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" placeholder="搜索学生..." v-model="searchQuery">
                            <button class="btn btn-outline-secondary" @click="searchQuery = ''">清除</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-danger" @click="confirmDeleteAll">
                                <i class="fas fa-trash-alt me-1"></i>清空所有
                            </button>
                            <button class="btn btn-outline-success" @click="generateDemoData">
                                <i class="fas fa-magic me-1"></i>生成演示数据
                            </button>
                        </div>
                    </div>
                </div>
                <div class="legend mb-4">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4e73df;"></div>
                        <span>男生</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e83e8c;"></div>
                        <span>女生</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f6c23e;"></div>
                        <span>近视</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #6f42c1;"></div>
                        <span>内向(I)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #20c997;"></div>
                        <span>外向(E)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f8d7da;"></div>
                        <span>机动座位</span>
                    </div>
                </div>
                <div class="mbti-legend">
                    <div class="mbti-type bg-primary text-white" title="外向-直觉-情感-判断">ENFJ</div>
                    <div class="mbti-type bg-success text-white" title="外向-直觉-思维-判断">ENTJ</div>
                    <div class="mbti-type bg-info text-dark" title="外向-感觉-思维-判断">ESTJ</div>
                    <div class="mbti-type bg-warning text-dark" title="外向-感觉-情感-判断">ESFJ</div>
                    <div class="mbti-type bg-danger text-white" title="外向-直觉-情感-感知">ENFP</div>
                    <div class="mbti-type bg-secondary text-white" title="外向-直觉-思维-感知">ENTP</div>
                    <div class="mbti-type bg-dark text-white" title="外向-感觉-思维-感知">ESTP</div>
                    <div class="mbti-type bg-light text-dark" title="外向-感觉-情感-感知">ESFP</div>
                    <div class="mbti-type text-white" style="background-color: #6f42c1;" title="内向-直觉-情感-判断">INFJ</div>
                    <div class="mbti-type text-white" style="background-color: #20c997;" title="内向-直觉-思维-判断">INTJ</div>
                    <div class="mbti-type text-white" style="background-color: #fd7e14;" title="内向-感觉-思维-判断">ISTJ</div>
                    <div class="mbti-type text-white" style="background-color: #0dcaf0;" title="内向-感觉-情感-判断">ISFJ</div>
                    <div class="mbti-type text-white" style="background-color: #d63384;" title="内向-直觉-情感-感知">INFP</div>
                    <div class="mbti-type text-white" style="background-color: #6610f2;" title="内向-直觉-思维-感知">INTP</div>
                    <div class="mbti-type text-dark" style="background-color: #ffc107;" title="内向-感觉-思维-感知">ISTP</div>
                    <div class="mbti-type text-white" style="background-color: #198754;" title="内向-感觉-情感-感知">ISFP</div>
                </div>
                <div class="row" ref="studentListRef">
                    <div class="col-md-4 mb-3" v-for="student in filteredStudents" :key="student.id">
                        <div class="student-card" :class="student.gender === '女' ? 'girl' : 'boy'" 
                             :data-id="student.id" draggable="true"
                             @dragstart="onDragStart($event, student)"
                             @dragend="onDragEnd($event)">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="mb-1">{{ student.name }} <small class="text-muted">#{{ student.id }}</small></h5>
                                    <div class="d-flex gap-2 mb-1">
                                        <span class="badge" :class="student.gender === '女' ? 'bg-danger' : 'bg-primary'">
                                            {{ student.gender }}
                                        </span>
                                        <span class="badge bg-secondary">
                                            {{ student.height }}cm
                                        </span>
                                        <span class="badge" :class="student.vision === '近视' ? 'bg-warning' : 'bg-success'">
                                            {{ student.vision }}
                                        </span>
                                        <span class="badge badge-mbti" :class="'badge-mbti-' + student.personality[0]">
                                            {{ student.personality }}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger" @click.stop="deleteStudent(student.id)">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="height-indicator" :style="{'--pos': ((student.height - 140) / 60 * 100) + '%'}"></div>
                        </div>
                    </div>
                </div>
                <!-- 添加学生模态框 -->
                <div class="modal fade" :class="{ 'show': showAddStudentModal }" tabindex="-1" style="display: block;" v-if="showAddStudentModal">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">添加新学生</h5>
                                <button type="button" class="btn-close" @click="showAddStudentModal = false"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">学号</label>
                                            <input type="text" class="form-control" v-model="newStudent.id">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">姓名</label>
                                            <input type="text" class="form-control" v-model="newStudent.name">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">性别</label>
                                            <select class="form-select" v-model="newStudent.gender">
                                                <option value="男">男</option>
                                                <option value="女">女</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">身高 (cm)</label>
                                            <input type="number" class="form-control" v-model="newStudent.height" min="100" max="220">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">视力</label>
                                            <select class="form-select" v-model="newStudent.vision">
                                                <option value="正常">正常</option>
                                                <option value="近视">近视</option>
                                                <option value="远视">远视</option>
                                                <option value="弱视">弱视</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">MBTI性格类型</label>
                                            <select class="form-select" v-model="newStudent.personality">
                                                <option value="ENFJ">ENFJ - 教导型</option>
                                                <option value="ENTJ">ENTJ - 统帅型</option>
                                                <option value="ENFP">ENFP - 倡导型</option>
                                                <option value="ENTP">ENTP - 智多星型</option>
                                                <option value="ESFJ">ESFJ - 主人型</option>
                                                <option value="ESTJ">ESTJ - 管家型</option>
                                                <option value="ESFP">ESFP - 表演型</option>
                                                <option value="ESTP">ESTP - 挑战型</option>
                                                <option value="INFJ">INFJ - 咨询师型</option>
                                                <option value="INTJ">INTJ - 专家型</option>
                                                <option value="INFP">INFP - 治愈型</option>
                                                <option value="INTP">INTP - 建筑师型</option>
                                                <option value="ISFJ">ISFJ - 守护型</option>
                                                <option value="ISTJ">ISTJ - 检查员型</option>
                                                <option value="ISFP">ISFP - 艺术家型</option>
                                                <option value="ISTP">ISTP - 冒险家型</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" @click="showAddStudentModal = false">取消</button>
                                <button type="button" class="btn btn-primary" @click="addStudent">添加</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop fade show" v-if="showAddStudentModal"></div>
            </div>

            <!-- 座位编排标签页 -->
            <div v-if="currentTab === 'arrange'" class="no-print">
                <h3 class="mb-4"><i class="fas fa-chair me-2"></i>座位编排</h3>
                <div class="form-section">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">教室布局 (行×列)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" v-model="classroomRows" min="1" max="10" @change="updateLayout">
                                    <span class="input-group-text">×</span>
                                    <input type="number" class="form-control" v-model="classroomCols" min="1" max="10" @change="updateLayout">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">座位模式</label>
                                <select class="form-select" v-model="deskMode" @change="updateLayout">
                                    <option value="single">单桌</option>
                                    <option value="pair">同桌</option>
                                    <option value="mixed">混合模式</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">讲台位置</label>
                                <select class="form-select" v-model="teacherDeskPosition" @change="updateLayout">
                                    <option value="front">前方</option>
                                    <option value="back">后方</option>
                                    <option value="left">左侧</option>
                                    <option value="right">右侧</option>
                                    <option value="both">两侧</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">编排规则</label>
                                <select class="form-select" v-model="currentRuleSet">
                                    <option v-for="(rule, index) in ruleSets" :value="index">
                                        {{ rule.name }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">机动座位数量</label>
                                <input type="number" class="form-control" v-model="reservedSeatsCount" min="0" :max="classroomRows * classroomCols" @change="updateReservedSeats">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">讲台座位</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showTeacherSeats" v-model="showTeacherSeats" @change="updateLayout">
                                    <label class="form-check-label" for="showTeacherSeats">显示讲台座位</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="classroom-layout-preview">
                        <div class="layout-preview-item" 
                             v-for="(layout, index) in layoutPresets" 
                             :key="index"
                             :class="{active: selectedLayout === index}"
                             @click="applyLayoutPreset(index)">
                            <div class="layout-preview-row" v-for="(row, rowIndex) in layout.preview" :key="rowIndex">
                                <div class="layout-preview-seat" 
                                     v-for="(seat, seatIndex) in row" 
                                     :key="seatIndex"
                                     :class="{
                                         single: seat === 'single',
                                         pair: seat === 'pair',
                                         reserved: seat === 'reserved',
                                         teacher: seat === 'teacher'
                                     }"></div>
                            </div>
                            <div class="text-center small p-1">{{ layout.name }}</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-flex justify-content-end gap-2">
                                <button class="btn btn-primary" @click="autoArrange">
                                    <i class="fas fa-magic me-1"></i>智能编排
                                </button>
                                <button class="btn btn-success" @click="manualArrange">
                                    <i class="fas fa-random me-1"></i>随机编排
                                </button>
                                <button class="btn btn-danger" @click="clearSeats">
                                    <i class="fas fa-trash-alt me-1"></i>清空座位
                                </button>
                                <button class="btn btn-info" @click="printSeating">
                                    <i class="fas fa-print me-1"></i>打印座位图
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="preview-container">
                    <h5 class="text-center mb-3">教室座位预览</h5>
                    <div class="classroom-grid" 
                         :style="{
                             'grid-template-rows': `repeat(${classroomRows}, 1fr)`,
                             'grid-template-columns': `repeat(${classroomCols}, 1fr)`,
                             '--cols': classroomCols
                         }" ref="seatGridRef">
                        <div class="blackboard" v-if="teacherDeskPosition === 'front' || teacherDeskPosition === 'back'">
                            <i class="fas fa-chalkboard me-2"></i>黑板
                        </div>
                        <div class="teacher-desk" v-if="teacherDeskPosition === 'left' || teacherDeskPosition === 'right'"
                             :style="{
                                 'grid-column': teacherDeskPosition === 'left' ? '1' : teacherDeskPosition === 'right' ? classroomCols : '',
                                 'grid-row': '1 / -1'
                             }">
                            <i class="fas fa-chalkboard-teacher me-2"></i>讲台
                        </div>
                        <div v-for="(seat, index) in seats" :key="index" 
                             :class="{
                                 'grid-column-span-2': deskMode === 'pair' && (index % classroomCols) % 2 === 0,
                                 'mixed-left': deskMode === 'mixed' && seat.position === 'left',
                                 'mixed-right': deskMode === 'mixed' && seat.position === 'right',
                                 'mixed-center': deskMode === 'mixed' && seat.position === 'center'
                             }"
                             :data-seat-index="index" 
                             class="seat-container"
                             @dragover.prevent="onDragOver($event, index)"
                             @dragleave="onDragLeave($event, index)"
                             @drop.prevent="onDrop($event, index)">
                            <div class="seat" :class="{
                                'occupied': seat.student,
                                'empty': !seat.student && !seat.reserved,
                                'reserved': seat.reserved
                            }">
                                <div v-if="seat.student" class="text-center">
                                    <div>{{ seat.student.name }}</div>
                                    <div>
                                        <span class="badge" :class="seat.student.gender === '女' ? 'bg-danger' : 'bg-primary'">
                                            {{ seat.student.gender }}
                                        </span>
                                        <span class="badge badge-mbti" :class="'badge-mbti-' + seat.student.personality[0]">
                                            {{ seat.student.personality }}
                                        </span>
                                    </div>
                                </div>
                                <div v-else-if="seat.reserved">
                                    <i class="fas fa-ban text-danger"></i>
                                </div>
                                <div v-else>
                                    <i class="fas fa-chair text-muted"></i>
                                </div>
                            </div>
                            <div class="seat-actions" v-if="seat.student || seat.reserved">
                                <button class="btn btn-sm btn-outline-danger" @click="removeStudentFromSeat(index)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="teacher-desk" v-if="showTeacherSeats && (teacherDeskPosition === 'both' || teacherDeskPosition === 'left')"
                             :style="{
                                 'grid-column': '1',
                                 'grid-row': '1 / -1'
                             }">
                            <i class="fas fa-chalkboard-teacher me-2"></i>讲台
                        </div>
                        <div class="teacher-desk" v-if="showTeacherSeats && (teacherDeskPosition === 'both' || teacherDeskPosition === 'right')"
                             :style="{
                                 'grid-column': classroomCols,
                                 'grid-row': '1 / -1'
                             }">
                            <i class="fas fa-chalkboard-teacher me-2"></i>讲台
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <h5>未分配学生</h5>
                    <div class="row" ref="unassignedListRef">
                        <div class="col-md-3 col-sm-6 mb-3" v-for="student in unassignedStudents" :key="student.id">
                            <div class="student-card" :class="student.gender === '女' ? 'girl' : 'boy'" 
                                 :data-id="student.id" draggable="true"
                                 @dragstart="onDragStart($event, student)"
                                 @dragend="onDragEnd($event)">
                                <div>{{ student.name }}</div>
                                <div>
                                    <span class="badge" :class="student.gender === '女' ? 'bg-danger' : 'bg-primary'">
                                        {{ student.gender }}
                                    </span>
                                    <span class="badge badge-mbti" :class="'badge-mbti-' + student.personality[0]">
                                        {{ student.personality }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="currentTab === 'arrange'" class="print-area" style="display: none;">
                <h2 class="text-center mb-4">班级座位安排表</h2>
                <p><strong>教室布局：</strong>{{ classroomRows }}行 × {{ classroomCols }}列，{{ {single: '单桌', pair: '同桌', mixed: '混合模式'}[deskMode] }}，讲台在{{ {front: '前方', back: '后方', left: '左侧', right: '右侧', both: '两侧'}[teacherDeskPosition] }}</p>
                <div class="classroom-grid" 
                     :style="{
                         'grid-template-rows': `repeat(${classroomRows}, 1fr)`,
                         'grid-template-columns': `repeat(${classroomCols}, 1fr)`,
                         '--cols': classroomCols
                     }">
                    <div class="blackboard" v-if="teacherDeskPosition === 'front' || teacherDeskPosition === 'back'">黑板</div>
                    <div class="teacher-desk" v-if="teacherDeskPosition === 'left' || teacherDeskPosition === 'right'"
                         :style="{
                             'grid-column': teacherDeskPosition === 'left' ? '1' : teacherDeskPosition === 'right' ? classroomCols : '',
                             'grid-row': '1 / -1'
                         }">讲台</div>
                    <div v-for="(seat, index) in seats" :key="index" 
                         :class="{
                             'grid-column-span-2': deskMode === 'pair' && (index % classroomCols) % 2 === 0,
                             'mixed-left': deskMode === 'mixed' && seat.position === 'left',
                             'mixed-right': deskMode === 'mixed' && seat.position === 'right',
                             'mixed-center': deskMode === 'mixed' && seat.position === 'center'
                         }">
                        <div class="seat" :class="{
                            'occupied': seat.student,
                            'empty': !seat.student && !seat.reserved,
                            'reserved': seat.reserved
                        }">
                            <div v-if="seat.student" class="text-center">
                                <div>{{ seat.student.name }}</div>
                                <div>
                                    <span class="badge" :class="seat.student.gender === '女' ? 'bg-danger' : 'bg-primary'">
                                        {{ seat.student.gender }}
                                    </span>
                                </div>
                            </div>
                            <div v-else-if="seat.reserved">
                                <i class="fas fa-ban text-danger"></i>
                            </div>
                            <div v-else>
                                <i class="fas fa-chair text-muted"></i>
                            </div>
                        </div>
                    </div>
                    <div class="teacher-desk" v-if="showTeacherSeats && (teacherDeskPosition === 'both' || teacherDeskPosition === 'left')"
                         :style="{
                             'grid-column': '1',
                             'grid-row': '1 / -1'
                         }">讲台</div>
                    <div class="teacher-desk" v-if="showTeacherSeats && (teacherDeskPosition === 'both' || teacherDeskPosition === 'right')"
                         :style="{
                             'grid-column': classroomCols,
                             'grid-row': '1 / -1'
                         }">讲台</div>
                </div>
            </div>

            <!-- 编排规则标签页 -->
            <div v-if="currentTab === 'rules'" class="no-print">
                <h3 class="mb-4"><i class="fas fa-ruler-combined me-2"></i>编排规则</h3>
                <div class="form-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">规则集名称</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" v-model="newRuleSetName">
                                    <button class="btn btn-success" @click="addRuleSet">
                                        <i class="fas fa-plus me-1"></i>添加规则集
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">当前规则集</label>
                                <select class="form-select" v-model="currentRuleSet">
                                    <option v-for="(rule, index) in ruleSets" :value="index">
                                        {{ rule.name }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="rules-container">
                    <h5 class="mb-3">当前规则</h5>
                    <div class="rule-item" v-for="(rule, index) in currentRules.rules" :key="index">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ ruleTypes[rule.type].label }}</strong>
                                <div class="text-muted small">{{ ruleTypes[rule.type].description }}</div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-danger" @click="removeRule(index)">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div v-if="rule.type === 'height'" class="mt-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" :id="'height-asc-'+index" 
                                       v-model="rule.order" value="asc">
                                <label class="form-check-label" :for="'height-asc-'+index">矮在前</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" :id="'height-desc-'+index" 
                                       v-model="rule.order" value="desc">
                                <label class="form-check-label" :for="'height-desc-'+index">高在前</label>
                            </div>
                        </div>
                        <div v-if="rule.type === 'vision'" class="mt-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" :id="'vision-front-'+index" 
                                       v-model="rule.front">
                                <label class="form-check-label" :for="'vision-front-'+index">近视学生优先前排</label>
                            </div>
                        </div>
                        <div v-if="rule.type === 'gender'" class="mt-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" :id="'gender-mixed-'+index" 
                                       v-model="rule.mode" value="mixed">
                                <label class="form-check-label" :for="'gender-mixed-'+index">男女混合</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" :id="'gender-separated-'+index" 
                                       v-model="rule.mode" value="separated">
                                <label class="form-check-label" :for="'gender-separated-'+index">男女分开</label>
                            </div>
                        </div>
                        <div v-if="rule.type === 'personality'" class="mt-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" :id="'personality-complementary-'+index" 
                                       v-model="rule.mode" value="complementary">
                                <label class="form-check-label" :for="'personality-complementary-'+index">性格互补</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" :id="'personality-similar-'+index" 
                                       v-model="rule.mode" value="similar">
                                <label class="form-check-label" :for="'personality-similar-'+index">性格相似</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary me-2" @click="showAddRuleModal = true">
                            <i class="fas fa-plus me-1"></i>添加规则
                        </button>
                        <button class="btn btn-outline-secondary" @click="importRules">
                            <i class="fas fa-file-import me-1"></i>导入规则
                        </button>
                        <button class="btn btn-outline-success ms-2" @click="exportRules">
                            <i class="fas fa-file-export me-1"></i>导出规则
                        </button>
                    </div>
                </div>
                <!-- 添加规则模态框 -->
                <div class="modal fade" :class="{ 'show': showAddRuleModal }" tabindex="-1" style="display: block;" v-if="showAddRuleModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">添加编排规则</h5>
                                <button type="button" class="btn-close" @click="showAddRuleModal = false"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">规则类型</label>
                                    <select class="form-select" v-model="newRule.type">
                                        <option v-for="(type, key) in ruleTypes" :value="key">
                                            {{ type.label }}
                                        </option>
                                    </select>
                                    <small class="form-text text-muted">{{ ruleTypes[newRule.type].description }}</small>
                                </div>
                                <div class="mb-3" v-if="newRule.type === 'height'">
                                    <label class="form-label">排序方式</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="height-asc" 
                                               v-model="newRule.order" value="asc">
                                        <label class="form-check-label" for="height-asc">矮在前</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="height-desc" 
                                               v-model="newRule.order" value="desc">
                                        <label class="form-check-label" for="height-desc">高在前</label>
                                    </div>
                                </div>
                                <div class="mb-3" v-if="newRule.type === 'vision'">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="vision-front" 
                                               v-model="newRule.front">
                                        <label class="form-check-label" for="vision-front">近视学生优先前排</label>
                                    </div>
                                </div>
                                <div class="mb-3" v-if="newRule.type === 'gender'">
                                    <label class="form-label">性别安排</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="gender-mixed" 
                                               v-model="newRule.mode" value="mixed">
                                        <label class="form-check-label" for="gender-mixed">男女混合</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="gender-separated" 
                                               v-model="newRule.mode" value="separated">
                                        <label class="form-check-label" for="gender-separated">男女分开</label>
                                    </div>
                                </div>
                                <div class="mb-3" v-if="newRule.type === 'personality'">
                                    <label class="form-label">性格安排</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="personality-complementary" 
                                               v-model="newRule.mode" value="complementary">
                                        <label class="form-check-label" for="personality-complementary">性格互补</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="personality-similar" 
                                               v-model="newRule.mode" value="similar">
                                        <label class="form-check-label" for="personality-similar">性格相似</label>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" @click="showAddRuleModal = false">取消</button>
                                <button type="button" class="btn btn-primary" @click="addRule">添加</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop fade show" v-if="showAddRuleModal"></div>
            </div>

            <!-- 数据导入标签页 -->
            <div v-if="currentTab === 'import'" class="no-print">
                <h3 class="mb-4"><i class="fas fa-file-import me-2"></i>数据导入</h3>
                <div class="form-section">
                    <div class="mb-3">
                        <label class="form-label">选择Excel文件</label>
                        <input type="file" class="form-control" @change="handleFileUpload" accept=".xlsx,.xls">
                    </div>
                    <div v-if="excelData.length > 0">
                        <h5 class="mt-4">智能列识别结果</h5>
                        <div class="alert alert-info">
                            系统已自动识别以下列，请确认或手动调整。
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">学号:</label>
                                    <select class="form-select" v-model="columnMapping.id">
                                        <option value="">-- 选择列 --</option>
                                        <option v-for="(header, index) in excelHeaders" :value="index" :selected="autoMapping.id === index">
                                            {{ header }} (列{{ index + 1 }}) {{ autoMapping.id === index ? '(自动识别)' : '' }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">姓名:</label>
                                    <select class="form-select" v-model="columnMapping.name">
                                        <option value="">-- 选择列 --</option>
                                        <option v-for="(header, index) in excelHeaders" :value="index" :selected="autoMapping.name === index">
                                            {{ header }} (列{{ index + 1 }}) {{ autoMapping.name === index ? '(自动识别)' : '' }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">性别:</label>
                                    <select class="form-select" v-model="columnMapping.gender">
                                        <option value="">-- 选择列 --</option>
                                        <option v-for="(header, index) in excelHeaders" :value="index" :selected="autoMapping.gender === index">
                                            {{ header }} (列{{ index + 1 }}) {{ autoMapping.gender === index ? '(自动识别)' : '' }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">身高(cm):</label>
                                    <select class="form-select" v-model="columnMapping.height">
                                        <option value="">-- 选择列 --</option>
                                        <option v-for="(header, index) in excelHeaders" :value="index" :selected="autoMapping.height === index">
                                            {{ header }} (列{{ index + 1 }}) {{ autoMapping.height === index ? '(自动识别)' : '' }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">视力:</label>
                                    <select class="form-select" v-model="columnMapping.vision">
                                        <option value="">-- 选择列 --</option>
                                        <option v-for="(header, index) in excelHeaders" :value="index" :selected="autoMapping.vision === index">
                                            {{ header }} (列{{ index + 1 }}) {{ autoMapping.vision === index ? '(自动识别)' : '' }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">MBTI性格:</label>
                                    <select class="form-select" v-model="columnMapping.personality">
                                        <option value="">-- 选择列 --</option>
                                        <option v-for="(header, index) in excelHeaders" :value="index" :selected="autoMapping.personality === index">
                                            {{ header }} (列{{ index + 1 }}) {{ autoMapping.personality === index ? '(自动识别)' : '' }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <div>
                                <button class="btn btn-outline-secondary" @click="excelData = []">
                                    <i class="fas fa-times me-1"></i>取消导入
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-primary" @click="importStudents">
                                    <i class="fas fa-check me-1"></i>确认导入
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <h5>导入规则</h5>
                    <div class="form-section">
                        <div class="mb-3">
                            <label class="form-label">选择规则文件 (JSON)</label>
                            <input type="file" class="form-control" @change="handleRuleFileUpload" accept=".json">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 数据导出标签页 -->
            <div v-if="currentTab === 'export'" class="no-print">
                <h3 class="mb-4"><i class="fas fa-file-export me-2"></i>数据导出</h3>
                <div class="form-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">导出选项</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="export-students" 
                                           v-model="exportOptions.students" checked>
                                    <label class="form-check-label" for="export-students">学生数据</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="export-seating" 
                                           v-model="exportOptions.seating">
                                    <label class="form-check-label" for="export-seating">座位安排</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="export-rules" 
                                           v-model="exportOptions.rules">
                                    <label class="form-check-label" for="export-rules">编排规则</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">导出格式</label>
                                <select class="form-select" v-model="exportOptions.format">
                                    <option value="excel">Excel (.xlsx)</option>
                                    <option value="json">JSON (.json)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button class="btn btn-primary" @click="exportData">
                            <i class="fas fa-download me-1"></i>导出数据
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;
        createApp({
            setup() {
                const currentTab = ref('students');
                const students = ref([]);
                const newStudent = ref({
                    id: '',
                    name: '',
                    gender: '男',
                    height: 160,
                    vision: '正常',
                    personality: 'INTJ'
                });
                const showAddStudentModal = ref(false);
                const searchQuery = ref('');
                const classroomRows = ref(5);
                const classroomCols = ref(6);
                const deskMode = ref('single');
                const teacherDeskPosition = ref('front');
                const showTeacherSeats = ref(false);
                const reservedSeatsCount = ref(0);
                const seats = ref([]);
                const selectedLayout = ref(-1);
                const layoutPresets = ref([
                    {
                        name: "标准单桌",
                        deskMode: "single",
                        teacherDeskPosition: "front",
                        preview: [
                            ["single", "single", "single", "single"],
                            ["single", "single", "single", "single"],
                            ["single", "single", "single", "single"]
                        ]
                    },
                    {
                        name: "标准同桌",
                        deskMode: "pair",
                        teacherDeskPosition: "front",
                        preview: [
                            ["pair", "pair"],
                            ["pair", "pair"],
                            ["pair", "pair"]
                        ]
                    },
                    {
                        name: "混合模式-两侧单桌",
                        deskMode: "mixed",
                        teacherDeskPosition: "front",
                        preview: [
                            ["single", "pair", "pair", "single"],
                            ["single", "pair", "pair", "single"],
                            ["single", "pair", "pair", "single"]
                        ]
                    },
                    {
                        name: "混合模式-中间单桌",
                        deskMode: "mixed",
                        teacherDeskPosition: "front",
                        preview: [
                            ["pair", "single", "single", "pair"],
                            ["pair", "single", "single", "pair"],
                            ["pair", "single", "single", "pair"]
                        ]
                    },
                    {
                        name: "带机动座位",
                        deskMode: "single",
                        teacherDeskPosition: "front",
                        preview: [
                            ["single", "single", "single", "single"],
                            ["single", "reserved", "reserved", "single"],
                            ["single", "single", "single", "single"]
                        ]
                    },
                    {
                        name: "讲台两侧",
                        deskMode: "single",
                        teacherDeskPosition: "both",
                        preview: [
                            ["teacher", "single", "single", "teacher"],
                            ["teacher", "single", "single", "teacher"],
                            ["teacher", "single", "single", "teacher"]
                        ]
                    }
                ]);
                const ruleSets = ref([
                    {
                        name: '默认规则',
                        rules: [
                            { type: 'vision', front: true },
                            { type: 'height', order: 'asc' },
                            { type: 'gender', mode: 'mixed' },
                            { type: 'personality', mode: 'complementary' }
                        ]
                    }
                ]);
                const currentRuleSet = ref(0);
                const newRuleSetName = ref('');
                const showAddRuleModal = ref(false);
                const newRule = ref({ type: 'height', order: 'asc' });
                const ruleTypes = {
                    height: {
                        label: '身高规则',
                        description: '根据学生身高安排座位'
                    },
                    vision: {
                        label: '视力规则',
                        description: '安排近视学生优先前排'
                    },
                    gender: {
                        label: '性别规则',
                        description: '控制男女学生的座位安排'
                    },
                    personality: {
                        label: '性格规则',
                        description: '根据MBTI性格安排座位'
                    }
                };
                const excelData = ref([]);
                const excelHeaders = ref([]);
                const columnMapping = ref({
                    id: '',
                    name: '',
                    gender: '',
                    height: '',
                    vision: '',
                    personality: ''
                });
                const autoMapping = ref({
                    id: null,
                    name: null,
                    gender: null,
                    height: null,
                    vision: null,
                    personality: null
                });
                const exportOptions = ref({
                    students: true,
                    seating: false,
                    rules: false,
                    format: 'excel'
                });
                const studentListRef = ref(null);
                const seatGridRef = ref(null);
                const unassignedListRef = ref(null);
                let draggingStudent = null;
                let draggingSeatIndex = null;

                const filteredStudents = computed(() => {
                    if (!searchQuery.value) return students.value;
                    const query = searchQuery.value.toLowerCase();
                    return students.value.filter(s => 
                        s.name.toLowerCase().includes(query) || 
                        s.id.toLowerCase().includes(query) ||
                        s.personality.toLowerCase().includes(query)
                    );
                });
                const currentRules = computed(() => {
                    return ruleSets.value[currentRuleSet.value] || { name: '', rules: [] };
                });
                const unassignedStudents = computed(() => {
                    const assignedIds = seats.value
                        .filter(s => s.student)
                        .map(s => s.student.id);
                    return students.value.filter(s => !assignedIds.includes(s.id));
                });

                const initSeats = () => {
                    const totalSeats = classroomRows.value * classroomCols.value;
                    seats.value = Array(totalSeats).fill().map((_, index) => ({
                        id: index,
                        student: null,
                        reserved: false,
                        position: 'center'
                    }));
                    updateReservedSeats();
                    if (deskMode.value === 'mixed') {
                        updateMixedModePositions();
                    }
                };

                const updateMixedModePositions = () => {
                    seats.value.forEach((seat, index) => {
                        const col = index % classroomCols.value;
                        if (col === 0) {
                            seat.position = 'left';
                        } else if (col === classroomCols.value - 1) {
                            seat.position = 'right';
                        } else {
                            seat.position = 'center';
                        }
                    });
                };

                const updateReservedSeats = () => {
                    seats.value.forEach(seat => {
                        seat.reserved = false;
                    });
                    const count = Math.min(reservedSeatsCount.value, seats.value.length);
                    for (let i = 0; i < count; i++) {
                        const index = seats.value.length - 1 - i;
                        if (index >= 0) {
                            seats.value[index].reserved = true;
                            seats.value[index].student = null;
                        }
                    }
                };

                const applyLayoutPreset = (index) => {
                    const preset = layoutPresets.value[index];
                    deskMode.value = preset.deskMode;
                    teacherDeskPosition.value = preset.teacherDeskPosition;
                    selectedLayout.value = index;
                    if (preset.preview.length > 0) {
                        classroomRows.value = preset.preview.length;
                        classroomCols.value = preset.preview[0].length;
                    }
                    if (preset.name.includes('机动座位')) {
                        reservedSeatsCount.value = 2;
                    } else {
                        reservedSeatsCount.value = 0;
                    }
                    if (preset.name.includes('讲台两侧')) {
                        showTeacherSeats.value = true;
                    }
                    updateLayout();
                };

                const updateLayout = () => {
                    initSeats();
                    selectedLayout.value = -1;
                };

                const saveToStorage = () => {
                    const data = {
                        students: students.value,
                        ruleSets: ruleSets.value,
                        currentRuleSet: currentRuleSet.value,
                        classroom: {
                            rows: classroomRows.value,
                            cols: classroomCols.value,
                            deskMode: deskMode.value,
                            teacherDeskPosition: teacherDeskPosition.value,
                            showTeacherSeats: showTeacherSeats.value,
                            reservedSeatsCount: reservedSeatsCount.value
                        },
                        seats: seats.value
                    };
                    localStorage.setItem('seatingArrangementData', JSON.stringify(data));
                };

                const loadFromStorage = () => {
                    const saved = localStorage.getItem('seatingArrangementData');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            students.value = data.students || [];
                            ruleSets.value = data.ruleSets || ruleSets.value;
                            currentRuleSet.value = data.currentRuleSet !== undefined ? data.currentRuleSet : 0;
                            if (data.classroom) {
                                classroomRows.value = data.classroom.rows;
                                classroomCols.value = data.classroom.cols;
                                deskMode.value = data.classroom.deskMode;
                                teacherDeskPosition.value = data.classroom.teacherDeskPosition;
                                showTeacherSeats.value = data.classroom.showTeacherSeats || false;
                                reservedSeatsCount.value = data.classroom.reservedSeatsCount || 0;
                            }
                            seats.value = data.seats || [];
                            if (seats.value.length === 0) {
                                initSeats();
                            }
                        } catch (e) {
                            console.error('加载本地数据失败:', e);
                            initSeats();
                        }
                    } else {
                        initSeats();
                    }
                };

                const identifyColumns = (headers) => {
                    const mappings = {};
                    const keywordMap = {
                        id: ['学号', 'id', '编号', '号'],
                        name: ['姓名', '名字', 'name'],
                        gender: ['性别', 'sex', 'gender'],
                        height: ['身高', '高度', 'height', 'cm'],
                        vision: ['视力', '眼睛', 'vision', '视力情况'],
                        personality: ['性格', 'mbti', '人格', '类型', '性格类型']
                    };

                    headers.forEach((header, index) => {
                        const headerLower = header.toLowerCase();
                        Object.keys(keywordMap).forEach(key => {
                            if (mappings[key] !== undefined) return;
                            const keywords = keywordMap[key];
                            if (keywords.some(kw => headerLower.includes(kw.toLowerCase()))) {
                                mappings[key] = index;
                            }
                        });
                    });
                    return mappings;
                };

                const onDragStart = (event, student, seatIndex = null) => {
                    draggingStudent = student;
                    draggingSeatIndex = seatIndex;
                    event.dataTransfer.setData('text/plain', student.id);
                    event.target.classList.add('dragging');
                };

                const onDragEnd = (event) => {
                    event.target.classList.remove('dragging');
                };

                const onDragOver = (event, seatIndex) => {
                    event.preventDefault();
                    const seat = seats.value[seatIndex];
                    if (!seat.reserved) {
                        event.currentTarget.classList.add('dropzone');
                    }
                };

                const onDragLeave = (event, seatIndex) => {
                    event.currentTarget.classList.remove('dropzone');
                };

                const onDrop = (event, seatIndex) => {
                    event.currentTarget.classList.remove('dropzone');
                    const seat = seats.value[seatIndex];
                    if (seat.reserved) return;
                    
                    if (draggingStudent) {
                        // 如果是从座位拖动，则交换位置
                        if (draggingSeatIndex !== null) {
                            const tempStudent = seat.student;
                            seat.student = draggingStudent;
                            seats.value[draggingSeatIndex].student = tempStudent;
                        } else {
                            // 如果是从学生列表拖动，则直接放置
                            seat.student = draggingStudent;
                        }
                        saveToStorage();
                    }
                };

                const addStudent = () => {
                    if (!newStudent.value.id || !newStudent.value.name) {
                        Swal.fire({
                            icon: 'error',
                            title: '输入不完整',
                            text: '请填写学号和姓名',
                            confirmButtonColor: '#4e73df'
                        });
                        return;
                    }
                    if (students.value.some(s => s.id === newStudent.value.id)) {
                        Swal.fire({
                            icon: 'error',
                            title: '学号已存在',
                            text: '该学号已存在，请使用不同的学号',
                            confirmButtonColor: '#4e73df'
                        });
                        return;
                    }
                    students.value.push({ ...newStudent.value });
                    newStudent.value = {
                        id: '',
                        name: '',
                        gender: '男',
                        height: 160,
                        vision: '正常',
                        personality: 'INTJ'
                    };
                    showAddStudentModal.value = false;
                    Swal.fire({
                        icon: 'success',
                        title: '添加成功',
                        text: '学生信息已成功添加',
                        confirmButtonColor: '#4e73df',
                        timer: 1500
                    });
                };

                const deleteStudent = (id) => {
                    Swal.fire({
                        title: '确认删除',
                        text: '确定要删除这个学生吗？',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#4e73df',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '确认删除',
                        cancelButtonText: '取消'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            students.value = students.value.filter(s => s.id !== id);
                            seats.value.forEach(seat => {
                                if (seat.student && seat.student.id === id) {
                                    seat.student = null;
                                }
                            });
                            Swal.fire({
                                icon: 'success',
                                title: '删除成功',
                                text: '学生信息已删除',
                                confirmButtonColor: '#4e73df',
                                timer: 1500
                            });
                        }
                    });
                };

                const confirmDeleteAll = () => {
                    Swal.fire({
                        title: '确认删除所有学生',
                        text: '此操作将删除所有学生数据，且不可恢复！',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#4e73df',
                        confirmButtonText: '确认删除',
                        cancelButtonText: '取消'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            students.value = [];
                            seats.value.forEach(seat => {
                                seat.student = null;
                            });
                            Swal.fire({
                                icon: 'success',
                                title: '删除成功',
                                text: '所有学生数据已删除',
                                confirmButtonColor: '#4e73df',
                                timer: 1500
                            });
                        }
                    });
                };

                const generateDemoData = () => {
                    Swal.fire({
                        title: '生成演示数据',
                        text: '这将覆盖当前所有学生数据，是否继续？',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#4e73df',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '确认生成',
                        cancelButtonText: '取消'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const demoStudents = [
                                { id: '1001', name: '张三', gender: '男', height: 165, vision: '正常', personality: 'INTJ' },
                                { id: '1002', name: '李四', gender: '男', height: 170, vision: '近视', personality: 'ENTP' },
                                { id: '1003', name: '王五', gender: '男', height: 175, vision: '正常', personality: 'ISTJ' },
                                { id: '1004', name: '赵六', gender: '男', height: 168, vision: '近视', personality: 'ENFJ' },
                                { id: '1005', name: '钱七', gender: '男', height: 172, vision: '正常', personality: 'ISFP' },
                                { id: '1006', name: '孙八', gender: '男', height: 166, vision: '正常', personality: 'ESTP' },
                                { id: '1007', name: '周九', gender: '男', height: 169, vision: '近视', personality: 'INFP' },
                                { id: '1008', name: '吴十', gender: '男', height: 171, vision: '正常', personality: 'ENTJ' },
                                { id: '1009', name: '郑十一', gender: '女', height: 160, vision: '正常', personality: 'INFJ' },
                                { id: '1010', name: '王十二', gender: '女', height: 158, vision: '近视', personality: 'ESFJ' },
                                { id: '1011', name: '李十三', gender: '女', height: 162, vision: '正常', personality: 'ISTP' },
                                { id: '1012', name: '张十四', gender: '女', height: 155, vision: '近视', personality: 'ENFP' },
                                { id: '1013', name: '刘十五', gender: '女', height: 163, vision: '正常', personality: 'ISFJ' },
                                { id: '1014', name: '陈十六', gender: '女', height: 159, vision: '正常', personality: 'ESTJ' },
                                { id: '1015', name: '杨十七', gender: '女', height: 161, vision: '近视', personality: 'INTP' },
                                { id: '1016', name: '黄十八', gender: '女', height: 157, vision: '正常', personality: 'ESFP' }
                            ];
                            students.value = demoStudents;
                            Swal.fire({
                                icon: 'success',
                                title: '演示数据已生成',
                                text: '已成功生成16名演示学生数据',
                                confirmButtonColor: '#4e73df',
                                timer: 1500
                            });
                        }
                    });
                };

                const calculateCompatibility = (typeA, typeB) => {
                    const weights = [3, 2, 2, 1];
                    let score = 0;
                    for (let i = 0; i < 4; i++) {
                        if (typeA[i] === typeB[i]) {
                            score += weights[i];
                        } else {
                            score -= weights[i];
                        }
                    }
                    return score;
                };

                const findBestMatch = (student, candidates, mode) => {
                    if (candidates.length === 0) return null;
                    if (candidates.length === 1) return candidates[0];

                    let bestStudent = candidates[0];
                    let bestScore = -Infinity;

                    candidates.forEach(candidate => {
                        const score = calculateCompatibility(student.personality, candidate.personality);
                        const isComplementary = score < 0;
                        const isSimilar = score > 0;

                        if ((mode === 'complementary' && isComplementary && score > bestScore) ||
                            (mode === 'similar' && isSimilar && score > bestScore) ||
                            (score > bestScore)) {
                            bestScore = score;
                            bestStudent = candidate;
                        }
                    });

                    return bestStudent;
                };

                const autoArrange = () => {
                    if (students.value.length === 0) {
                        Swal.fire({
                            icon: 'error',
                            title: '没有学生数据',
                            text: '请先添加学生数据',
                            confirmButtonColor: '#4e73df'
                        });
                        return;
                    }
                    
                    const loadingSwal = Swal.fire({
                        title: '正在智能编排...',
                        html: '系统正在根据规则自动安排座位',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // 使用setTimeout让UI有时间更新
                    setTimeout(() => {
                        initSeats();
                        let remainingStudents = [...students.value];

                        currentRules.value.rules.forEach(rule => {
                            if (rule.type === 'height') {
                                remainingStudents.sort((a, b) => {
                                    return rule.order === 'asc' ? a.height - b.height : b.height - a.height;
                                });
                            } else if (rule.type === 'vision' && rule.front) {
                                const nearSighted = remainingStudents.filter(s => s.vision === '近视');
                                const others = remainingStudents.filter(s => s.vision !== '近视');
                                remainingStudents = [...nearSighted, ...others];
                            } else if (rule.type === 'gender' && rule.mode === 'separated') {
                                remainingStudents.sort((a, b) => a.gender.localeCompare(b.gender));
                            }
                        });

                        for (let i = 0; i < seats.value.length && remainingStudents.length > 0; i++) {
                            const seat = seats.value[i];
                            if (!seat.student && !seat.reserved) {
                                let selectedStudent;

                                const personalityRule = currentRules.value.rules.find(r => r.type === 'personality');
                                if (personalityRule && i > 0 && seats.value[i-1].student) {
                                    selectedStudent = findBestMatch(seats.value[i-1].student, remainingStudents, personalityRule.mode);
                                } else {
                                    selectedStudent = remainingStudents[0];
                                }

                                seat.student = selectedStudent;
                                remainingStudents = remainingStudents.filter(s => s.id !== selectedStudent.id);
                            }
                        }
                        
                        loadingSwal.close();
                        Swal.fire({
                            icon: 'success',
                            title: '编排完成',
                            text: '座位已根据规则自动安排',
                            confirmButtonColor: '#4e73df',
                            timer: 1500
                        });
                    }, 100);
                };

                const manualArrange = () => {
                    Swal.fire({
                        title: '随机编排座位',
                        text: '这将随机分配所有学生到座位，是否继续？',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#4e73df',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '确认',
                        cancelButtonText: '取消'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            initSeats();
                            const shuffled = [...students.value].sort(() => Math.random() - 0.5);
                            let studentIndex = 0;
                            for (let i = 0; i < seats.value.length && studentIndex < shuffled.length; i++) {
                                if (!seats.value[i].reserved) {
                                    seats.value[i].student = shuffled[studentIndex];
                                    studentIndex++;
                                }
                            }
                            Swal.fire({
                                icon: 'success',
                                title: '随机编排完成',
                                text: '学生已随机分配到座位',
                                confirmButtonColor: '#4e73df',
                                timer: 1500
                            });
                        }
                    });
                };

                const clearSeats = () => {
                    Swal.fire({
                        title: '清空所有座位',
                        text: '确定要清空所有座位吗？',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#4e73df',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '确认清空',
                        cancelButtonText: '取消'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            seats.value.forEach(seat => {
                                seat.student = null;
                            });
                            Swal.fire({
                                icon: 'success',
                                title: '清空完成',
                                text: '所有座位已清空',
                                confirmButtonColor: '#4e73df',
                                timer: 1500
                            });
                        }
                    });
                };

                const removeStudentFromSeat = (seatIndex) => {
                    seats.value[seatIndex].student = null;
                };

                const addRuleSet = () => {
                    if (!newRuleSetName.value) {
                        Swal.fire({
                            icon: 'error',
                            title: '规则集名称不能为空',
                            text: '请输入规则集名称',
                            confirmButtonColor: '#4e73df'
                        });
                        return;
                    }
                    ruleSets.value.push({
                        name: newRuleSetName.value,
                        rules: []
                    });
                    currentRuleSet.value = ruleSets.value.length - 1;
                    newRuleSetName.value = '';
                    Swal.fire({
                        icon: 'success',
                        title: '添加成功',
                        text: '规则集已添加',
                        confirmButtonColor: '#4e73df',
                        timer: 1500
                    });
                };

                const addRule = () => {
                    if (!newRule.value.type) {
                        Swal.fire({
                            icon: 'error',
                            title: '请选择规则类型',
                            text: '必须选择一种规则类型',
                            confirmButtonColor: '#4e73df'
                        });
                        return;
                    }
                    const existingIndex = currentRules.value.rules.findIndex(r => r.type === newRule.value.type);
                    if (existingIndex >= 0) {
                        currentRules.value.rules[existingIndex] = { ...newRule.value };
                    } else {
                        currentRules.value.rules.push({ ...newRule.value });
                    }
                    showAddRuleModal.value = false;
                    newRule.value = { type: 'height', order: 'asc' };
                    Swal.fire({
                        icon: 'success',
                        title: '规则已添加',
                        text: '新规则已添加到当前规则集',
                        confirmButtonColor: '#4e73df',
                        timer: 1500
                    });
                };

                const removeRule = (index) => {
                    Swal.fire({
                        title: '确认删除规则',
                        text: '确定要删除这条规则吗？',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#4e73df',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '确认删除',
                        cancelButtonText: '取消'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            currentRules.value.rules.splice(index, 1);
                            Swal.fire({
                                icon: 'success',
                                title: '删除成功',
                                text: '规则已删除',
                                confirmButtonColor: '#4e73df',
                                timer: 1500
                            });
                        }
                    });
                };

                const importRules = () => {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json';
                    fileInput.onchange = e => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = event => {
                            try {
                                const data = JSON.parse(event.target.result);
                                if (Array.isArray(data)) {
                                    Swal.fire({
                                        title: '确认导入规则',
                                        text: `将导入${data.length}个规则集，这会覆盖现有规则集，是否继续？`,
                                        icon: 'warning',
                                        showCancelButton: true,
                                        confirmButtonColor: '#4e73df',
                                        cancelButtonColor: '#d33',
                                        confirmButtonText: '确认导入',
                                        cancelButtonText: '取消'
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            ruleSets.value = data;
                                            currentRuleSet.value = 0;
                                            Swal.fire({
                                                icon: 'success',
                                                title: '导入成功',
                                                text: `已成功导入${data.length}个规则集`,
                                                confirmButtonColor: '#4e73df',
                                                timer: 1500
                                            });
                                        }
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: '无效的规则文件格式',
                                        text: '规则文件必须是规则集数组',
                                        confirmButtonColor: '#4e73df'
                                    });
                                }
                            } catch (err) {
                                Swal.fire({
                                    icon: 'error',
                                    title: '解析规则文件失败',
                                    text: err.message,
                                    confirmButtonColor: '#4e73df'
                                });
                            }
                        };
                        reader.readAsText(file);
                    };
                    fileInput.click();
                };

                const exportRules = () => {
                    const dataStr = JSON.stringify(ruleSets.value, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                    const exportName = '座位编排规则_' + new Date().toISOString().slice(0, 10) + '.json';
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportName);
                    linkElement.click();
                    Swal.fire({
                        icon: 'success',
                        title: '导出成功',
                        text: '规则集已导出为JSON文件',
                        confirmButtonColor: '#4e73df',
                        timer: 1500
                    });
                };

                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const loadingSwal = Swal.fire({
                        title: '正在读取文件...',
                        html: '请稍候，系统正在处理Excel文件',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            if (jsonData.length > 0) {
                                excelHeaders.value = jsonData[0];
                                excelData.value = jsonData.slice(1);
                                const autoMap = identifyColumns(excelHeaders.value);
                                autoMapping.value = autoMap;
                                if (autoMap.name !== undefined) columnMapping.value.name = autoMap.name;
                                if (autoMap.id !== undefined) columnMapping.value.id = autoMap.id;
                                if (autoMap.gender !== undefined) columnMapping.value.gender = autoMap.gender;
                                if (autoMap.height !== undefined) columnMapping.value.height = autoMap.height;
                                if (autoMap.vision !== undefined) columnMapping.value.vision = autoMap.vision;
                                if (autoMap.personality !== undefined) columnMapping.value.personality = autoMap.personality;
                            }
                            loadingSwal.close();
                            Swal.fire({
                                icon: 'success',
                                title: '文件读取成功',
                                text: `已读取${excelData.value.length}行数据`,
                                confirmButtonColor: '#4e73df'
                            });
                        } catch (err) {
                            loadingSwal.close();
                            Swal.fire({
                                icon: 'error',
                                title: '读取Excel文件失败',
                                text: err.message,
                                confirmButtonColor: '#4e73df'
                            });
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };

                const parsePersonality = (value) => {
                    value = String(value).toUpperCase().trim();
                    const mbtiRegex = /^[IE][NS][TF][JP]$/;
                    if (mbtiRegex.test(value)) {
                        return value;
                    }
                    const chineseMap = {
                        '教导型': 'ENFJ', '统帅型': 'ENTJ', '倡导型': 'ENFP', '智多星型': 'ENTP',
                        '主人型': 'ESFJ', '管家型': 'ESTJ', '表演型': 'ESFP', '挑战型': 'ESTP',
                        '咨询师型': 'INFJ', '专家型': 'INTJ', '治愈型': 'INFP', '建筑师型': 'INTP',
                        '守护型': 'ISFJ', '检查员型': 'ISTJ', '艺术家型': 'ISFP', '冒险家型': 'ISTP'
                    };
                    for (const [key, type] of Object.entries(chineseMap)) {
                        if (value.includes(key)) {
                            return type;
                        }
                    }
                    return 'INTJ';
                };

                const importStudents = () => {
                    if (excelData.value.length === 0) {
                        Swal.fire({
                            icon: 'error',
                            title: '没有可导入的数据',
                            text: '请先上传Excel文件',
                            confirmButtonColor: '#4e73df'
                        });
                        return;
                    }
                    const mapping = columnMapping.value;
                    if (!mapping.name) {
                        Swal.fire({
                            icon: 'error',
                            title: '姓名列是必填项',
                            text: '请映射姓名列',
                            confirmButtonColor: '#4e73df'
                        });
                        return;
                    }
                    if (!mapping.height) {
                        Swal.fire({
                            icon: 'error',
                            title: '身高列是必填项',
                            text: '请映射身高列',
                            confirmButtonColor: '#4e73df'
                        });
                        return;
                    }
                    if (!mapping.id) {
                        Swal.fire({
                            icon: 'warning',
                            title: '学号列未映射',
                            text: '将使用姓名作为学号',
                            confirmButtonColor: '#4e73df'
                        });
                    }

                    const newStudents = [];
                    const errors = [];
                    excelData.value.forEach((row, rowIndex) => {
                        try {
                            const student = {
                                id: mapping.id !== '' ? String(row[mapping.id] || `TEMP_${rowIndex}`).trim() : String(row[mapping.name] || `TEMP_${rowIndex}`).trim(),
                                name: String(row[mapping.name] || '').trim(),
                                gender: mapping.gender !== '' ? String(row[mapping.gender] || '男').trim() : '男',
                                height: mapping.height !== '' ? parseInt(row[mapping.height]) || 160 : 160,
                                vision: mapping.vision !== '' ? String(row[mapping.vision] || '正常').trim() : '正常',
                                personality: mapping.personality !== '' ? 
                                    parsePersonality(row[mapping.personality]) : 'INTJ'
                            };

                            if (!student.name) {
                                errors.push(`第${rowIndex+2}行：姓名为空`);
                                return;
                            }
                            if (isNaN(student.height) || student.height < 100 || student.height > 220) {
                                errors.push(`第${rowIndex+2}行：身高无效（${row[mapping.height]}）`);
                                student.height = 160;
                            }

                            if (student.gender.includes('女') || student.gender === 'F' || student.gender === 'female') {
                                student.gender = '女';
                            } else {
                                student.gender = '男';
                            }

                            if (student.vision.includes('近视')) {
                                student.vision = '近视';
                            } else if (student.vision.includes('远视')) {
                                student.vision = '远视';
                            } else if (student.vision.includes('弱视')) {
                                student.vision = '弱视';
                            } else {
                                student.vision = '正常';
                            }

                            newStudents.push(student);
                        } catch (e) {
                            errors.push(`第${rowIndex+2}行：处理错误`);
                        }
                    });

                    if (errors.length > 0) {
                        Swal.fire({
                            icon: 'warning',
                            title: '导入过程中发现错误',
                            html: `共发现${errors.length}个错误：<br><small>${errors.slice(0, 5).join('<br>')}${errors.length > 5 ? '<br>...' : ''}</small>`,
                            confirmButtonColor: '#4e73df'
                        });
                    }

                    if (newStudents.length > 0) {
                        Swal.fire({
                            title: '确认导入学生',
                            html: `将导入${newStudents.length}名学生${errors.length > 0 ? `，但有${errors.length}个错误` : ''}，是否继续？`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#4e73df',
                            cancelButtonColor: '#d33',
                            confirmButtonText: '确认导入',
                            cancelButtonText: '取消'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                students.value = newStudents;
                                Swal.fire({
                                    icon: 'success',
                                    title: '导入成功',
                                    text: `已成功导入 ${newStudents.length} 名学生`,
                                    confirmButtonColor: '#4e73df',
                                    timer: 1500
                                });
                                excelData.value = [];
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: '没有有效的学生数据',
                            text: '未能从文件中提取有效的学生数据',
                            confirmButtonColor: '#4e73df'
                        });
                    }
                };

                const handleRuleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                Swal.fire({
                                    title: '确认导入规则',
                                    text: `将导入${data.length}个规则集，这会覆盖现有规则集，是否继续？`,
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#4e73df',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: '确认导入',
                                    cancelButtonText: '取消'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        ruleSets.value = data;
                                        currentRuleSet.value = 0;
                                        Swal.fire({
                                            icon: 'success',
                                            title: '导入成功',
                                            text: `已成功导入${data.length}个规则集`,
                                            confirmButtonColor: '#4e73df',
                                            timer: 1500
                                        });
                                    }
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: '无效的规则文件格式',
                                    text: '规则文件必须是规则集数组',
                                    confirmButtonColor: '#4e73df'
                                });
                            }
                        } catch (err) {
                            Swal.fire({
                                icon: 'error',
                                title: '解析规则文件失败',
                                text: err.message,
                                confirmButtonColor: '#4e73df'
                            });
                        }
                    };
                    reader.readAsText(file);
                };

                const exportData = () => {
                    if (!exportOptions.value.students && !exportOptions.value.seating && !exportOptions.value.rules) {
                        Swal.fire({
                            icon: 'error',
                            title: '请选择导出选项',
                            text: '请至少选择一个导出选项',
                            confirmButtonColor: '#4e73df'
                        });
                        return;
                    }
                    
                    const loadingSwal = Swal.fire({
                        title: '正在准备导出...',
                        html: '系统正在处理导出数据',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    setTimeout(() => {
                        if (exportOptions.value.format === 'json') {
                            const data = {};
                            if (exportOptions.value.students) {
                                data.students = students.value;
                            }
                            if (exportOptions.value.seating) {
                                data.seating = {
                                    rows: classroomRows.value,
                                    cols: classroomCols.value,
                                    deskMode: deskMode.value,
                                    teacherDeskPosition: teacherDeskPosition.value,
                                    showTeacherSeats: showTeacherSeats.value,
                                    reservedSeatsCount: reservedSeatsCount.value,
                                    seats: seats.value.map(s => s.student ? s.student.id : null)
                                };
                            }
                            if (exportOptions.value.rules) {
                                data.rules = ruleSets.value;
                            }
                            const dataStr = JSON.stringify(data, null, 2);
                            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                            let exportName = '座位编排数据_';
                            if (exportOptions.value.students) exportName += '学生_';
                            if (exportOptions.value.seating) exportName += '座位_';
                            if (exportOptions.value.rules) exportName += '规则_';
                            exportName += new Date().toISOString().slice(0, 10) + '.json';
                            const linkElement = document.createElement('a');
                            linkElement.setAttribute('href', dataUri);
                            linkElement.setAttribute('download', exportName);
                            linkElement.click();
                        } else {
                            const wb = XLSX.utils.book_new();
                            if (exportOptions.value.students) {
                                const studentData = students.value.map(s => ({
                                    学号: s.id,
                                    姓名: s.name,
                                    性别: s.gender,
                                    身高: s.height,
                                    视力: s.vision,
                                    MBTI性格: s.personality
                                }));
                                const ws = XLSX.utils.json_to_sheet(studentData);
                                XLSX.utils.book_append_sheet(wb, ws, "学生数据");
                            }
                            if (exportOptions.value.seating) {
                                const seatingData = [];
                                for (let row = 0; row < classroomRows.value; row++) {
                                    const rowData = [];
                                    for (let col = 0; col < classroomCols.value; col++) {
                                        const index = row * classroomCols.value + col;
                                        if (index < seats.value.length) {
                                            if (seats.value[index].student) {
                                                rowData.push(seats.value[index].student.name);
                                            } else if (seats.value[index].reserved) {
                                                rowData.push('(机动)');
                                            } else {
                                                rowData.push('');
                                            }
                                        } else {
                                            rowData.push('');
                                        }
                                    }
                                    seatingData.push(rowData);
                                }
                                const ws = XLSX.utils.aoa_to_sheet(seatingData);
                                XLSX.utils.book_append_sheet(wb, ws, "座位安排");
                            }
                            if (exportOptions.value.rules) {
                                const rulesData = ruleSets.value.map((set, index) => ({
                                    规则集名称: set.name,
                                    是否当前: index === currentRuleSet.value ? '是' : '否',
                                    规则描述: set.rules.map(r => {
                                        if (r.type === 'height') return `身高: ${r.order === 'asc' ? '矮在前' : '高在前'}`;
                                        if (r.type === 'vision') return `视力: ${r.front ? '近视优先前排' : '无特殊安排'}`;
                                        if (r.type === 'gender') return `性别: ${r.mode === 'mixed' ? '男女混合' : '男女分开'}`;
                                        if (r.type === 'personality') return `性格: ${r.mode === 'complementary' ? '性格互补' : '性格相似'}`;
                                        return '';
                                    }).join('; ')
                                }));
                                const ws = XLSX.utils.json_to_sheet(rulesData);
                                XLSX.utils.book_append_sheet(wb, ws, "编排规则");
                            }
                            const exportName = '座位编排数据_' + new Date().toISOString().slice(0, 10) + '.xlsx';
                            XLSX.writeFile(wb, exportName);
                        }
                        
                        loadingSwal.close();
                        Swal.fire({
                            icon: 'success',
                            title: '导出成功',
                            text: '数据已成功导出',
                            confirmButtonColor: '#4e73df',
                            timer: 1500
                        });
                    }, 100);
                };

                const printSeating = () => {
                    window.print();
                };

                onMounted(() => {
                    loadFromStorage();
                    document.addEventListener('dragend', (e) => {
                        if (e.target.classList.contains('student-card') || e.target.classList.contains('seat')) {
                            e.target.classList.remove('dragging');
                        }
                    });
                });

                watch([students, ruleSets, currentRuleSet, classroomRows, classroomCols, deskMode, teacherDeskPosition, showTeacherSeats, reservedSeatsCount, seats], () => {
                    saveToStorage();
                }, { deep: true });

                return {
                    currentTab,
                    students,
                    newStudent,
                    showAddStudentModal,
                    searchQuery,
                    filteredStudents,
                    classroomRows,
                    classroomCols,
                    deskMode,
                    teacherDeskPosition,
                    showTeacherSeats,
                    reservedSeatsCount,
                    seats,
                    layoutPresets,
                    selectedLayout,
                    ruleSets,
                    currentRuleSet,
                    currentRules,
                    newRuleSetName,
                    showAddRuleModal,
                    newRule,
                    ruleTypes,
                    excelData,
                    excelHeaders,
                    columnMapping,
                    autoMapping,
                    exportOptions,
                    unassignedStudents,
                    studentListRef,
                    seatGridRef,
                    unassignedListRef,
                    onDragStart,
                    onDragEnd,
                    onDragOver,
                    onDragLeave,
                    onDrop,
                    addStudent,
                    deleteStudent,
                    confirmDeleteAll,
                    generateDemoData,
                    autoArrange,
                    manualArrange,
                    clearSeats,
                    removeStudentFromSeat,
                    addRuleSet,
                    addRule,
                    removeRule,
                    importRules,
                    exportRules,
                    handleFileUpload,
                    importStudents,
                    handleRuleFileUpload,
                    exportData,
                    printSeating,
                    applyLayoutPreset,
                    updateLayout
                };
            }
        }).mount('#app');
    </script>
</body>
</html>